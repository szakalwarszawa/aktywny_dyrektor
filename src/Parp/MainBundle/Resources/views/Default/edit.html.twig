{% extends '::base.html.twig' %}

{% block body %} 
    <div class="col-sm-12">
        <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#general">Dane podstawowe</a></li>
            <li><a data-toggle="tab" href="#daneRekord">Dane z systemu rekord</a></li>
            <li><a data-toggle="tab" href="#zasoby">Zasoby użytkownika</a></li>
            <li><a data-toggle="tab" href="#uprawnienia">Uprawnienia użytkownika</a></li>
            <li><a data-toggle="tab" href="#historia">Historia zmian</a></li>
            <li><a data-toggle="tab" href="#oczekujace">Oczekujące zmiany</a></li>
            {%if(userGroups|length > 0)%}
            <li><a data-toggle="tab" href="#grupyAD">Grupy w AD</a></li>
            {%endif%}
        </ul>
        
        <div class="tab-content">
            <div id="general" class="tab-pane fade in active">
                <h3>{{ user.name }}</h3>
                <div  class="tabContent">
                    <form class="form-horizontal" method="POST" role="form">
                        {{  form_start(form) }}
                        <div class="form-group">
                            {{ form_label(form.samaccountname) }}
                            <div class="col-sm-8">{{ form_widget(form.samaccountname) }}</div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.cn) }}
                            <div class="col-sm-8">{{ form_widget(form.cn) }}</div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.initials) }}
                            <div class="col-sm-4">
                                {{ form_widget(form.initials) }}
                            </div>
                            <div class="col-sm-4">
                                <a class="btn btn-primary col-sm-12" id="suggestinitials" name="suggestinitials"><i class="fa fa-search"></i> Zasugeruj</a>
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.department) }}
                            <div class="col-sm-8">{{ form_widget(form.department) }}</div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.title) }}
                            <div class="col-sm-4">{{ form_widget(form.title) }}</div>
                            <div class="col-sm-4"><a class="btn btn-primary col-sm-12" href="{{ path('engageUser', {samaccountname: user.samaccountname}) }}"><i class="fa fa-puzzle-piece"></i> Zaangażowanie</a></div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.initialrights) }}
                            <div class="col-sm-4">{{ form_widget(form.initialrights) }}</div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.info) }}
                            <div class="col-sm-8">
                                <div class="input-group">
                                    <div id="formRowInfo">
                                    {{ form_widget(form.info) }}
                                    </div>
                                    {{ form_widget(form.infoNew)}}
                                    <span class="input-group-addon">
                                        <button class="btn btn-primary fa fa-edit" onclick="event.preventDefault(); var hideCombo = $('#form_infoNew').attr('type') == 'hidden';  if(hideCombo){$('#formRowInfo').addClass('hidden'); $('#form_infoNew').attr('type', 'text');}else{$('#formRowInfo').removeClass('hidden'); $('#form_infoNew').attr('type', 'hidden');}">
                                        Nowa Sekcja
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        {#<div class="form-group">#}
                        {#{{ form_label(form.description) }}#}
                        {#<div class="col-sm-8">{{ form_widget(form.description) }}</div>#}
                        {#</div>#}
                        {#<div class="form-group">#}
                        {#{{ form_label(form.division) }}#}
                        {#<div class="col-sm-8">{{ form_widget(form.division) }}</div>#}
                        {#</div>#}
                        <div class="form-group">
                            {{ form_label(form.manager) }}
                            <div class="col-sm-4">
                                {{ form_widget(form.manager) }}
                            </div>
                            <div class="col-sm-4 btn-group">
                                <a class="btn btn-primary col-sm-6" id="nadaj" name="nadaj"><i class="fa fa-users"></i>{% if form.manager %}Zmień{% else %}Nadaj{% endif %}</a>
                                <a class="btn btn-primary col-sm-6" href="{{ path('structure',{samaccountname: user.samaccountname }) }}"><i class="fa fa-sitemap"></i> Struktura</a>
                            </div>
                        </div>
                                    
                        <div class="form-group">
                            {{ form_label(form.accountExpires) }}
                            <div class='col-sm-8'>
                                <div class="input-group datepicker"  id="datepicker1">
                                    {{ form_widget(form.accountExpires) }}
                                    <span class="input-group-addon">
                                        <span class="fa fa-calendar"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.isDisabled) }}
                            <div class='col-sm-8'>
                                <div class="input-group">
                                    {{ form_widget(form.isDisabled, {'attr': {'onchange' : 'if($(this).val() == 1){$("#disableDescriptionDiv").removeClass("hidden");}else{$("#form_disableDescription").val("");$("#disableDescriptionDiv").addClass("hidden");}'}}) }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group {{ form.vars.value.isDisabled ? '' : 'hidden'}}" id="disableDescriptionDiv" >
                            {{ form_label(form.disableDescription) }}
                            <div class='col-sm-8'>
                                <div class="input-group">
                                    {{ form_widget(form.disableDescription) }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.roles) }}
                            <div class="col-sm-4">{{ form_widget(form.roles) }}</div>
                        </div>
                        <div class="form-group">
                            {{ form_label(form.fromWhen) }}
                            <div class='col-sm-8'>
                                <div class="input-group datepicker"  id="datepicker2">
                                    {{ form_widget(form.fromWhen) }}
                                    <span class="input-group-addon">
                                        <span class="fa fa-calendar"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% if form.zapisz is defined %}
                        <div class="form-group">
                            <div class="col-sm-6"><input type="button" class="btn btn-danger btncancel" disabled onclick="cancelForm()" value="Cofnij zmiany"/></div>
                            <div class="col-sm-6">{{ form_widget(form.zapisz) }}</div>
                        </div>
                        {%endif%}
                    {{ form_rest(form) }}
                </div>
            </div>
            <div id="daneRekord" class="tab-pane fade">
                {% if dane_rekord != null %}
                <table class="table striped" id="daneRekordTable">
                    <tr>
                        <th>Departament</th>
                        <td>{{ dane_rekord.departament}}</td>
                    </tr>
                    <tr>
                        <th>Stanowisko</th>
                        <td>{{ dane_rekord.stanowisko}}</td>
                    </tr>
                    <tr>
                        <th>Umowa</th>
                        <td>{{ dane_rekord.umowa}}</td>
                    </tr>
                    <tr>
                        <th>Umowa od</th>
                        <td>{{ dane_rekord.umowaOd|date('Y-m-d')}}</td>
                    </tr>
                    <tr>
                        <th>Umowa do</th>
                        <td>{{ dane_rekord.umowaDo|date('Y-m-d')}}</td>
                    </tr>
                </table>
                {% else %}
                    Nie ma jeszcze zainportowanych danych z systemu rekord
                {% endif %}
            </div>
            <div id="zasoby" class="tab-pane fade">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#zasobyActive">Zasoby użytkownika - aktywne</a></li>
                    <li><a data-toggle="tab" href="#zasobyNotActive">Zasoby użytkownika - nieaktywne</a></li>
                </ul>
                
                <div class="tab-content">
                    <div id="zasobyActive" class="tab-pane fade in active">
                        <div class="tabContent">
                            <a href="{{path('addRemoveAccessToUsersAction', {'samaccountnames' : { (user.samaccountname) : 1}|json_encode(), 'action' : 'addResources' })}}" class="btn btn-success">Dodaj zasoby</a>
                            <a href="{{path('addRemoveAccessToUsersAction', {'samaccountnames' : { (user.samaccountname) : 1}|json_encode(), 'action' : 'removeResources' })}}" class="btn btn-danger">Odbierz zasoby</a>
                                
                            {% if zasoby|length > 0 %}
                            <table class="table table-hover" id="userZasobyTable">
                                <thead>
                                    <tr>
                                        <th>Lp.</th>
                                        <th>Nazwa zasobu</th>
                                        <th>Login do zasobu</th>
                                        <th>Moduł</th>
                                        <th>Poziom dostępu</th>
                                        <th>Kanał dostępu</th>
                                        <th>Aktywne od</th>
                                        <th>Aktywne do</th>
                                        <th>Powód nadania/odebrania</th>
                                        <th>Wniosek</th>
                                    </tr>
                                </thead>
                                {% set n = 1 %}
                                <tbody>
                                    {% for row in zasoby %}
                                    {% if row.czyAktywne %}
                                        <tr>
                                            <td><a href="{{ path('userzasoby_edit', {id: row.id})}}"  data-toggle="tooltip"  data-placement="top" title="costam">{{ n }}</a></td>
                                            <td><a href="{{ path('userzasoby_edit', {id: row.id})}}" 
                                            data-toggle="popover" title="Uprawnienia" data-content="{{row.opisHtml|raw}}"
                                            >{{ row.nazwa  }}<br>{{row.opis|raw}}</a></td>
                                            <td>{{row.loginDoZasobu}}</td>
                                            <td>{{row.modul}}</td>
                                            <td>{{row.kanalDostepu}}</td>
                                            <td>{{row.poziomDostepu}}</td>
                                            <td>{{row.aktywneOd}}</td>
                                            <td>{{row.aktywneDo}}</td>
                                            <td>{{row.powodNadania}}</td>
                                            <td>
                                            {%if row.wniosekId != 0 %}
                                                <a href="{{path('wnioseknadanieodebraniezasobow_show', {id: row.wniosekId})}}">Wniosek nr {{row.wniosekNumer}}</a>
                                            {%else%}
                                                <div class="alert alert-danger">Bez wniosku</div>
                                            {%endif%}
                                            </td>
                                            
                                            
                                        </tr>
                                        {% set n = n + 1 %}
                                    {%endif%}
                                    {% endfor %}
                                </tbody>
                            
                            </table>
                            {% else %}
                            
                            <p>Użytkownik nie posiada uprawnień do żadnych zasobów.</p>
                            
                            {% endif %}
                        </div>
                    </div>
                    <div id="zasobyNotActive" class="tab-pane fade">
                        <div class="tabContent">
                            {% if zasoby|length > 0 %}
                            <table class="table table-hover" id="zasobyTable2">
                                <thead>
                                    <tr>
                                        <th>Lp.</th>
                                        <th>Nazwa zasobu</th>
                                        <th>Login do zasobu</th>
                                        <th>Moduł</th>
                                        <th>Poziom dostępu</th>
                                        <th>Kanał dostępu</th>
                                        <th>Aktywne od</th>
                                        <th>Aktywne do</th>
                                        <th>Powód nadania/odebrania</th>
                                    </tr>
                                </thead>
                                {% set n = 1 %}
                                <tbody>
                                    {% for row in zasoby %}
                                    {% if not row.czyAktywne %}
                                        <tr>
                                            <td><a href="{{ path('userzasoby_edit', {id: row.id})}}"  data-toggle="tooltip"  data-placement="top" title="costam">{{ n }}</a></td>
                                            <td><a href="{{ path('userzasoby_edit', {id: row.id})}}" 
                                            data-toggle="popover" title="Uprawnienia" data-content="{{row.opisHtml|raw}}"
                                            >{{ row.nazwa  }}<br>{{row.opis|raw}}</a></td>
                                            <td>{{row.loginDoZasobu}}</td>
                                            <td>{{row.modul}}</td>
                                            <td>{{row.kanalDostepu}}</td>
                                            <td>{{row.poziomDostepu}}</td>
                                            <td>{{row.aktywneOd}}</td>
                                            <td>{{row.aktywneDo}}</td>
                                            <td>{{row.powodNadania}}</td>
                                            
                                            
                                        </tr>
                                        {% set n = n + 1 %}
                                    {%endif%}
                                    {% endfor %}
                                </tbody>
                            
                            </table>
                            {% else %}
                            
                            <p>Użytkownik nie posiada uprawnień do żadnych zasobów.</p>
                            
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div id="uprawnienia" class="tab-pane fade">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#uprawnieniaActive">Uprawnienia użytkownika - aktywne</a></li>
                    <li><a data-toggle="tab" href="#uprawnieniaNotActive">Uprawnienia użytkownika - nieaktywne</a></li>
                </ul>
                
                <div class="tab-content">
                    <div id="uprawnieniaActive" class="tab-pane fade in active">
                        <div class="tabContent">
                            <a href="{{path('addRemoveAccessToUsersAction', {'samaccountnames' : { (user.samaccountname) : 1}|json_encode(), 'action' : 'addPrivileges' })}}" class="btn btn-success">Dodaj uprawnienia</a>
                            <a href="{{path('addRemoveAccessToUsersAction', {'samaccountnames' : { (user.samaccountname) : 1}|json_encode(), 'action' : 'removePrivileges' })}}" class="btn btn-danger">Odbierz uprawnienia</a>
                                
                            {% if uprawnienia|length > 0 %}
                                <table class="table table-hover" id="uprawnieniaTable">
                                    <thead>
                                        <tr>
                                            <th>Lp.</th>
                                            <th>Opis zasobu</th>
                                            <th>Data nadania</th>
                                            <th>Data odebrania</th>
                                            <th>Aktywne</th>
                                            <th>Jest w AD</th>
                                        <th>Powód nadania/odebrania</th>
                                        </tr>
                                    </thead>
                                    {% set n = 1 %}
                                    <tbody>
                                        {% for row in uprawnienia %}
                                        {% if row.czyAktywne %}
                                            <tr>
                                                <td><a href="{{ path('uprawnienia_edit', {id: row.uprawnienieId})}}">{{ n }}</a></td>
                                                <td><a href="{{ path('uprawnienia_edit', {id: row.uprawnienieId})}}">{{ row.opis  }}</a></td>
                                                <td>{{row.dataNadania|date}}</td>
                                                <td>{{row.dataOdebrania|date}}</td>
                                                <td>{{row.czyAktywne}}</td>
                                                <td>
                                                    {% if up2grupaAd[row.getUprawnienieId] is defined %}
                                                        {% if up2grupaAd[row.getUprawnienieId] not in grupyAd %}
                                                            NIE
                                                        {%else%}
                                                            TAK
                                                        {%endif%}
                                                    {%else%}
                                                        n/d
                                                    {%endif%}
                                                </td>
                                            <td>{{row.powodNadania}}</td>
                                            </tr>
                                            {% set n = n + 1 %}
                                        {%endif%}
                                        {% endfor %}
                                    </tbody>
                    
                                </table>
                            {% else %}
                                
                                <p>Użytkownik nie posiada żadnych uprawnień.</p>
                                
                            {% endif %}
                        </div>
                    </div>
                    <div id="uprawnieniaNotActive" class="tab-pane fade">
                        <div class="tabContent">
                            {% if uprawnienia|length > 0 %}
                                <table class="table table-hover" id="uprawnienia2Table">
                                    <thead>
                                        <tr>
                                            <th>Lp.</th>
                                            <th>Opis zasobu</th>
                                            <th>Data nadania</th>
                                            <th>Data odebrania</th>
                                            <th>Aktywne</th>
                                            <th>Jest w AD</th>
                                        <th>Powód nadania/odebrania</th>
                                        </tr>
                                    </thead>
                                    {% set n = 1 %}
                                    <tbody>
                                        {% for row in uprawnienia %}
                                        {% if not row.czyAktywne %}
                                            <tr>
                                                <td><a href="{{ path('uprawnienia_edit', {id: row.uprawnienieId})}}">{{ n }}</a></td>
                                                <td><a href="{{ path('uprawnienia_edit', {id: row.uprawnienieId})}}">{{ row.opis  }}</a></td>
                                                <td>{{row.dataNadania|date}}</td>
                                                <td>{{row.dataOdebrania|date}}</td>
                                                <td>{{row.czyAktywne}}</td>
                                                <td>
                                                    {% if up2grupaAd[row.getUprawnienieId] is defined %}
                                                        {% if up2grupaAd[row.getUprawnienieId] not in grupyAd %}
                                                            NIE
                                                        {%else%}
                                                            TAK
                                                        {%endif%}
                                                    {%else%}
                                                        n/d
                                                    {%endif%}
                                                </td>
                                            <td>{{row.powodNadania}}</td>
                                            </tr>
                                            {% set n = n + 1 %}
                                        {%endif%}
                                        {% endfor %}
                                    </tbody>
                    
                                </table>
                            {% else %}
                                
                                <p>Użytkownik nie posiada żadnych uprawnień.</p>
                                
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div id="historia" class="tab-pane fade">
                <div  class="tabContent">
                    {% if historyEntries|length > 0 %}
                        <table class="table table-hover" id="historiaTable">
                            <thead>
                                <tr>
                                    <th>Lp. (id)</th>
                                    <th>Imię i nazwisko</th>
                                    <th>Inicjały</th>
                                    <th>Departament</th>
                                    <th>Sekcja</th>
                                    <th>Manager</th>
                                    <th>Stanowisko</th>
                                    <th>Info</th>
                                    <th>Uprawnienia początkowe</th>
                                    <th>Ad zmiana</th>
                                    <th>Od kiedy</th>
                                </tr>
                            </thead>
                            {% set n = 1 %}
                            <tbody>
                                {% for row in historyEntries %}
                                    <tr>
                                        <td>{{ n }} ({{row.id}})</td>
                                        <td>{{ row.cn  }}</td>
                                        <td>{{row.initials}}</td>
                                        <td>{{row.department}}</td>
                                        <td>{{row.division}}</td>
                                        <td>{{row.manager}}</td>
                                        <td>{{row.title}}</td>
                                        <td>{{row.info}}</td>
                                        <td>{{row.initialrights}}</td>
                                        <td>{{row.distinguishedName}}</td>
                                        <td>{{row.fromWhen|date}}</td>
                                    </tr>
                                    {% set n = n + 1 %}
                                {% endfor %}
                            </tbody>
            
                        </table>
                    {% else %}
                        
                        <p>Użytkownik nie posiada żadnych oczejących zmian.</p>
                        
                    {% endif %}
                </div>
            </div>
            <div id="oczekujace" class="tab-pane fade">
                <div  class="tabContent">
                    {% if pendingEntries|length > 0 %}
                        <table class="table table-hover" id="oczekujaceTable">
                            <thead>
                                <tr>
                                    <th>Lp.</th>
                                    <th>Imię i nazwisko</th>
                                    <th>Inicjały</th>
                                    <th>Departament</th>
                                    <th>Sekcja</th>
                                    <th>Manager</th>
                                    <th>Stanowisko</th>
                                    <th>Info</th>
                                    <th>Uprawnienia początkowe</th>
                                    <th>Ad zmiana</th>
                                    <th>Od kiedy</th>
                                </tr>
                            </thead>
                            {% set n = 1 %}
                            <tbody>
                                {% for row in pendingEntries %}
                                    <tr>
                                        <td>{{ n }}</td>
                                        <td>{{ row.cn  }}</td>
                                        <td>{{row.initials}}</td>
                                        <td>{{row.department}}</td>
                                        <td>{{row.division}}</td>
                                        <td>{{row.manager}}</td>
                                        <td>{{row.title}}</td>
                                        <td>{{row.info}}</td>
                                        <td>{{row.initialrights}}</td>
                                        <td>{{row.distinguishedName}}</td>
                                        <td>{{row.fromWhen|date}}</td>
                                    </tr>
                                    {% set n = n + 1 %}
                                {% endfor %}
                            </tbody>
            
                        </table>
                    {% else %}
                        
                        <p>Użytkownik nie posiada żadnych oczejących zmian.</p>
                        
                    {% endif %}
                
                </div>
            </div>
            {%if(userGroups|length > 0)%}
            <div id="grupyAD" class="tab-pane fade">
                <ul class="list-group">
                    {% for g in userGroups %}
                        <li class="list-group-item">{{g}}</li>
                    {%endfor%}
                </ul> 
            </div>
            {%endif%}  
        </div>
    
    </div>

    <div id="myModal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Wybierz przełożonego</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="imienazwisko">Wpisz imie i nazwisko</label>
                            <input type="text" class="form-control" id="imienazwisko" placeholder="imie i nazwisko">
                        </div>
                        <div class="form-group" id="lista" name="lista">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Zamknij</button>
                    <button type="button" class="btn btn-primary" id="zapisz" name="zapisz">Zapisz</button>
                </div>
            </div>
        </div>
    </div>   
    <script type="text/javascript"src="{{ asset('js/userForm.js') }}"></script>
    <script>
        //$('#form_fromWhen').mask("9999-99-99");
        $('#suggestinitials').click(function () {
            var samaccountname = $('#form_samaccountname').val();
            var department = $('#form_department').val();
            var cn = $('#form_name').val();
            if (!samaccountname.trim()) {
                alert('Prosze wprrowadzic nazwę konta.');
                return;
            }
            if (!cn.trim()) {
                alert('Prosze wprowadzic imię i nazwisko pracownika.');
                return;
            }
            if (!department.trim()) {
                alert('Nie wybrano Biura/Departamentu');
                return;
            }
            $.post("{{ path('suggest_initials') }}", {samaccountname: samaccountname, department: department, cn: cn}, function (data) {
                $("#form_initials").val(data);
            }).fail(function () {
                alert("Wystapił błąd pobierania danych!");
            })
        });
        $('#nadaj').click(function () {
            //$("#myModal").modal('show');
            $('#myModal').modal('toggle');
        });
        $("#imienazwisko").keyup(function () {
            var imienazwisko = null;
            imienazwisko = $("#imienazwisko").val();
            if (imienazwisko.trim()) {
                $.post("{{ path('find_manager') }}", {imienazwisko: imienazwisko}, function (data) {
                    $("#lista").html(data);
                }).fail(function () {
                    alert("Wystapił błąd pobierania danych przy wyborze przełożonego!");
                })
            }
        });
        $('#zapisz').click(function () {
            $("#myModal").modal('hide');
            $("#form_manager").val($("#manager").val());
            $("#imienazwisko").val();
        });
    </script>
{% endblock %}