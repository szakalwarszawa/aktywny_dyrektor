{% extends '::base.html.twig' %}

{% block body -%}
    <div class="col-sm-12">
        <div class="alert alert-info">
            <h3>Wniosek o utworzenie zasobu numer : {{entity.wniosek.numer}}</h3>
            <ul>                
                <li><b>Pracownicy :</b> {{ entity.pracownicy }}</li>
                <li><b>Zasoby: </b>
                {% set i = 0 %}
                {% for z in entity.userZasoby %}                
                    {% set i = i + 1%}
                    {{z.zasobId|zasobNazwa}} {% if i != entity.userZasoby|length %},{%endif%}
                {% endfor%}
                </li>
                <li><b>Statusy:</b></li>
            </ul>
            <div class="well well-sm statusyWniosku">
                {% set bylJuzPierwszyParent = false %}
                {% set numerIteracji = 0 %}
                <ul class="list-inline">
                    {% for ss in entity.wniosek.statusy %}
                        {%if(ss.status.nazwaSystemowa == "10_PODZIELONY" and  numerIteracji != entity.wniosek.statusy|length -1)%}
                        {%set wniosekDoLinku = ((bylJuzPierwszyParent ? entity.wniosek.parent : (entity.wniosek.parent.parent  ? entity.wniosek.parent.parent : entity.wniosek.parent)))%}
                        {%endif%}
                        <li class="red-tooltip list-group-item btn-{{ ss.status.finished ? (ss.status.nazwaSystemowa == "07_ROZPATRZONY_POZYTYWNIE" ? "success" : "danger") : "default"}}"  
                        data-toggle="popover" title="Data: {{ ss.createdAt|date("Y-m-d H:i:s")}}" data-content="{{ ss.createdAt|date("Y-m-d H:i:s")}}  : {{ ss.createdBy }} {%if(ss.status.nazwaSystemowa == "10_PODZIELONY" and  numerIteracji != entity.wniosek.statusy|length -1)%}Podzielony wniosek nr {{wniosekDoLinku.numer}} {%endif%}"
                        >
                            {%if(ss.status.nazwaSystemowa == "10_PODZIELONY" and  numerIteracji != entity.wniosek.statusy|length -1)%}
                            
                            <a href="{{path('wnioseknadanieodebraniezasobow_show', {id: wniosekDoLinku.id})}}" class="whiteLink">
                            {% set bylJuzPierwszyParent = true %}
                            {%endif%}
                            <i class="glyphicon glyphicon-asterisk" >&nbsp;</i>{{ ss.statusName }} <i class="glyphicon glyphicon-{{ ss.status.finished ? (ss.status.nazwaSystemowa == "07_ROZPATRZONY_POZYTYWNIE" ? "ok-circle" : (ss.status.nazwaSystemowa == "10_PODZIELONY" ? "glyphicon glyphicon-random" : "remove-circle")) : "arrow-right"}}">&nbsp;</i> 
                            
                            {%if(ss.status.nazwaSystemowa == "10_PODZIELONY" and  numerIteracji != entity.wniosek.statusy|length - 1)%}
                            
                            </a>
                            {%endif%}
                            {% set numerIteracji = numerIteracji + 1 %}
                        </li>
                    {%endfor%}
                </ul>
            </div>
            <div class="btn-group container">  
                {% if editor %}
                    <h4>Akcje:</h4>
                    {%if entity.wniosek.status.nazwaSystemowa == "07_ROZPATRZONY_POZYTYWNIE" %}
                        {#jesli tu jestesmy znaczy ze jest ediutorem i jest pozytywnie wiec musi byc opublikowany do AD #}
                        <a href="{{ path('wnioseknadanieodebraniezasobow_accept_reject', {id : entity.id, isAccepted: 'publish'})}}" class="btn btn-danger">Opublikuj do AD<i class="glyphicon glyphicon-ok-sign">&nbsp;</i> </a>                    
                    {%else%}
                        <a data-toggle="collapse" data-target="#rejectDiv" onclick="$('#subFormOdrzucenie').attr('action', '{{ path('wnioseknadanieodebraniezasobow_accept_reject', {id : entity.id, isAccepted: 'reject'})}}');"
                        class="btn btn-danger">Odrzuć wniosek <i class="glyphicon glyphicon-remove-sign">&nbsp;</i> </a>
                        {% if canReturn %}
                        <a  data-toggle="collapse" data-target="#rejectDiv"  onclick="$('#subFormOdrzucenie').attr('action', '{{ path('wnioseknadanieodebraniezasobow_accept_reject', {id : entity.id, isAccepted: 'return'})}}');"
                        class="btn btn-info">Zwrot do poprawy wniosek <i class="glyphicon glyphicon-arrow-left">&nbsp;</i> </a>
                        
                        {%endif%}
                        {% if canUnblock %}
                        <a href="{{ path('wnioseknadanieodebraniezasobow_accept_reject', {id : entity.id, isAccepted: 'unblock'})}}" class="btn btn-primary">Odblokuj wniosek <i class="glyphicon glyphicon-check">&nbsp;</i> </a>
                        {%endif%}
                        {% if(entity.wniosek.status.nazwaSystemowa == "05_EDYCJA_ADMINISTRATOR") %}
                            <a href="{{ path('wnioseknadanieodebraniezasobow_accept_reject', {id : entity.id, isAccepted: 'acceptAndPublish'})}}" class="btn btn-success">Zaakceptuj wniosek <i class="glyphicon glyphicon-ok-sign">&nbsp;</i> </a>
                            <a href="{{ path('wnioseknadanieodebraniezasobow_accept_reject', {id : entity.id, isAccepted: 'accept'})}}" class="btn btn-success">Przekaż do administratora technicznego <i class="glyphicon glyphicon-ok-sign">&nbsp;</i> </a>
                        {%else%}
                            <a href="{{ path('wnioseknadanieodebraniezasobow_accept_reject', {id : entity.id, isAccepted: 'accept'})}}" class="btn btn-success">{{ entity.wniosek.status.nazwaSystemowa == "00_TWORZONY" ? "Złóż" : "Zaakceptuj"}} wniosek <i class="glyphicon glyphicon-ok-sign">&nbsp;</i> </a>
                        {%endif%}
                    {%endif%}
                    
                {% endif %}
            </div>
            <div class="collapse" id="rejectDiv">
                <form action="" method="POST" id="subFormOdrzucenie">
                    <div class="form-group">
                        <label class="col-sm-2 control-label required" for="parp_mainbundle_komentarz_opis">Powód zwrotu/odrzucenia wniosku</label>
                        <div class="col-sm-10">
                            <textarea id="powodZwrotu" name="powodZwrotu" class="form-control"  placeholder="Wpisz powod zwrotu/odrzucenia wniosku"></textarea>
                        </div>
                    </div>
                    <div class="form-group paddingTop20 container">
                        <div class="col-sm-2">
                        </div>
                        <div class="col-sm-10">
                        <button type="submit" class="btn btn-danger">Wykonaj akcje </button>
                        </div>
                    </div>
                </form>
                
            </div>
            {%if(entity.powodZwrotu != "")%}
                <div class="alert alert-danger">
                    <h3>Powód odrzucenia wniosku:</h3>
                    {{entity.powodZwrotu}}
                </div>
            {%endif%}
        </div>
    </div>
    
    <div class="col-sm-12">
        <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#general">Dane podstawowe</a></li>
            <li><a data-toggle="tab" href="#zasoby">Zasoby</a></li>
            <li><a data-toggle="tab" href="#pliki">Pliki</a></li>
            <li><a data-toggle="tab" href="#komentarze">Komentarze</a></li>
            <li><a data-toggle="tab" href="#historia">Historia wersji</a></li>
            <li><a data-toggle="tab" href="#historiaAkceptacji">Historia akceptacji</a></li>
            {%if(entity.wniosek.ADentries|length > 0)%}
            
            <li><a data-toggle="tab" href="#statusAD">Status w AD</a></li>
            {%endif%}
        </ul>
        
        <div class="tab-content">
            <div id="general" class="tab-pane fade in active">
                
                <div class="tabContent">
                    <table class="record_properties table table-striped">
                        <tbody>
                             <tr>
                                <th>Id</th>
                                <td>{{ entity.id }}</td>
                            </tr>
                            <tr>
                                <th>Numer</th>
                                <td>
                                    <div class="alert alert-success">{{ entity.wniosek.numer }}</div>
                                    
                                    {% if entity.wniosek.parent%}
                                        
                                        <a href="{{path('wnioseknadanieodebraniezasobow_show', {id: entity.wniosek.parent.wniosekNadanieOdebranieZasobow.id})}}" class="btn btn-info">powstał z podzielenia wniosku Wniosku o nr {{entity.wniosek.parent.numer}}</a>
                                    {%endif%}
                                </td>
                            </tr>
                            <tr>
                                <th>Status</th>
                                <td>
                                    {{ entity.wniosek.status }}
                                    {% if entity.wniosek.status.nazwaSystemowa == "10_PODZIELONY" %}
                                        Na wnioski:
                                        <ul class="list-group">
                                        {% for w in entity.wniosek.children %}
                                            <li class="list-group-item"><a class="btn btn-info" href="{{path('wnioseknadanieodebraniezasobow_show', {id: w.wniosekNadanieOdebranieZasobow.id})}}">Wniosek nr {{w.numer}} - {{w.status.nazwa}}</a></li>
                                        {%endfor %}                           
                                        </ul>
                                    {%endif%}
                                </td>
                            </tr>
                            <tr>
                                <th>Osoby których dotyczy wniosek</th>
                                <td>{{ entity.pracownicy }}</td>
                            </tr>
                            <tr>
                                <th>Czy pracownik/pracownicy spoza PARP</th>
                                <td>{{ entity.pracownikSpozaParp ? "TAK" : "NIE" }}</td>
                            </tr>
                            <tr>
                                <th>Jednostka organizacyjna</th>
                                <td>{{ entity.wniosek.jednostkaOrganizacyjna }}</td>
                            </tr>
                            <tr>
                                <th>Utworzony przez</th>
                                <td>{{ entity.wniosek.createdBy }}</td>
                            </tr>
                            <tr>
                                <th>Utworzony dnia</th>
                                <td>{{ entity.wniosek.createdAt|date('Y-m-d H:i:s') }}</td>
                            </tr>
                            <tr>
                                <th>Edytowany (zablokowany) przez</th>
                                <td>{{ entity.wniosek.lockedBy }}</td>
                            </tr>
                            <tr>
                                <th>Edytowany (zablokowany) dnia</th>
                                <td>{{ entity.wniosek.lockedAt|date('Y-m-d H:i:s') }}</td>
                            </tr>
                            
                            <tr>
                                <th>Osoby które widzą wniosek</th>
                                <td>{{ entity.wniosek.viewernames }}</td>
                            </tr>
                            <tr>
                                <th>Osoby które mogą edytować wniosek</th>
                                <td>{{ entity.wniosek.editornames }}</td>
                            </tr>
                            
                            
                            
                        </tbody>
                    </table>
                    {%if editor%}
                    
                    <a href="{{path('wnioseknadanieodebraniezasobow_edit', {id: entity.id})}}" class="btn btn-success">Dodaj / usuń użytkowników do wniosku</a>
                    {%endif%}
                </div>
            </div>            
            <div id="zasoby" class="tab-pane fade">
        
            
                {%if editor%}<a href="{{path('addRemoveAccessToUsersAction', {'wniosekId' : entity.id, 'action' : (entity.odebranie ? 'removeResources' : 'addResources'), 'samaccountnames' : entity.jsonSams})}}" class="btn btn-success">Dodaj zasoby</a>{%endif%}
                <table class="record_properties table table-striped tablesorter">
                    <thead>
                        <tr>
                            <th class="header">Nazwa</th>
                            <th class="header">Osoba</th>
                            <th class="header">Moduł</th>
                            <th class="header">Poziom dostępu</th>
                            <th class="header">Sumowanie uprawnień</th>
                            <th class="header">Aktywne od</th>
                            <th class="header">Bezterminowo</th>
                            <th class="header">Aktywne do</th>
                            <th class="header">Kanał dostępu</th>
                            <th class="header">Uprawnienia administracyjne</th>
                            <th class="header">Odstepstwo od procedury</th>   
                            <th class="header">Akcje</th>                            
                        </tr>
                    </thead>
                        <tbody>
                        {% for z in userzasoby %}
                            <tr>
                                <td><a href="{{path('zasoby_edit', {'id' : z.zasobId})}}">{{z.zasobNazwa}}</a></td>
                                <td><a href="{{path('userEdit', {'samaccountname' : z.samaccountname})}}">{{z.samaccountname}}</a></td>
                                <td>{{z.modul}}</td>
                                <td>{{z.poziomDostepu}}</td>
                                <td>{{z.sumowanieUprawnien ? "TAK" : "NIE"}}</td>
                                <td>{{z.aktywneOd|date("Y-m-d")}}</td>
                                <td>{{z.bezterminowo ? "TAK" : "NIE"}}</td>
                                <td>{{z.aktywneDo|date("Y-m-d")}}</td>
                                <td>{{z.kanalDostepu}}</td>
                                <td>{{z.uprawnieniaAdministracyjne ? "TAK" : "NIE"}}</td>
                                <td>{{z.odstepstwoOdProcedury ? "TAK" : "NIE"}}</td>
                                <td>{%if editor%}
                                    <a href="{{path('addRemoveAccessToUsersAction', {'wniosekId' : entity.id, 'action' : 'editResources','uzid' : z.id, 'samaccountnames' : z.samaccountnames})}}" class="btn btn-primary">Edycja</a>
                                    <a href="{{path('wnioseknadanieodebraniezasobow_delete_uz', {'id' : z.id})}}" class="btn btn-danger">Kasuj</a>
                                    {%endif%}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
            </div>         
            <div id="pliki" class="tab-pane fade">
                <div  class="tabContent">
                    {{ render(controller('ParpMainBundle:Plik:index', {obiekt: 'WniosekNadanieOdebranieZasobow', obiektId: entity.id})) }}
                </div>
            </div>            
            <div id="komentarze" class="tab-pane fade">
                <div  class="tabContent">
                    {{ render(controller('ParpMainBundle:Komentarz:index', {obiekt: 'WniosekNadanieOdebranieZasobow', obiektId: entity.id})) }}
                </div>
            </div>
            <div id="historia" class="tab-pane fade">
                <div  class="tabContent">
                    {{ render(controller('ParpMainBundle:Version:versionsHistory', {repository: 'WniosekNadanieOdebranieZasobow', id: entity.id})) }}
                </div>
            </div>
            <div id="historiaAkceptacji" class="tab-pane fade">
                <div  class="tabContent">
                    {% include 'ParpMainBundle:WniosekNadanieOdebranieZasobow:historiaAkceptacji.html.twig' %}                
                </div>
            </div>
            {%if(entity.wniosek.ADentries|length > 0)%}
            <div id="statusAD" class="tab-pane fade">
                <div  class="tabContent">
                    <table class="table striped">
                        <tr>
                            <th>Username</th>
                            <th>Nazwa grupy</th>
                            <th>Opublikowano</th>
                            <th>Ma byc w AD</th>
                            <th>Nadana w AD</th>
                        </tr>
                        {%for e in grupyAD%}
                            <tr>
                                <td><a href="{{path('userEdit', {'samaccountname' : e.entry.samaccountname})}}">{{e.entry.samaccountname}}</a></td>
                                <td>{{e.entry.memberOf}}</td>
                                <td>{{e.entry.isImplemented}}</td>
                                <td>
                                {% if e.maBycwAD%}
                                    <div class="alert alert-success">TAK</div>
                                {%else%}
                                    <div class="alert alert-danger">NIE</div>                                
                                {%endif%}
                                </td>
                                <td>
                                {% if e.nadanawAD%}
                                    <div class="alert alert-success">TAK</div>
                                {%else%}
                                    <div class="alert alert-danger">NIE</div>                                
                                {%endif%}
                                </td>
                            </tr>
                        {%endfor%}
                    </table>
                </div>
            </div>
            {%endif%}
        </div>
    </div>

    
    
<script type="text/javascript"src="{{ asset('js/wnioskiZasoby.js') }}"></script>

{% endblock %}
